<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AG Usage</title>
    <link rel="stylesheet" href="{{styleUri}}">
</head>

<body>
    <div class="header">
        <h1>AG STATUS</h1>
        <button class="refresh-btn" id="refresh">Refresh</button>
    </div>

    <!-- GLOBAL CREDITS -->
    <div class="card" style="margin-bottom: 2rem;">
        <div class="card-title">Prompt Credits (Monthly)</div>
        <div style="display: flex; align-items: baseline;">
            <div class="metric-large" id="credits-avail">--</div>
            <div class="metric-sub" style="margin-left: 10px;"> / <span id="credits-total">--</span></div>
        </div>
        <div class="bar-container">
            <div class="bar-fill" id="credits-bar" style="width: 0%"></div>
        </div>
    </div>

    <!-- WEEKLY ACTIVITY -->
    <div class="card" style="margin-bottom: 2rem;">
        <div class="card-title">Estimated Weekly Activity (Rolling 7 Days)</div>
        <div style="display: flex; align-items: baseline;">
            <div class="metric-large" id="weekly-usage">0.0</div>
            <div class="metric-sub" style="margin-left: 10px;"> Quotas Used</div>
        </div>
        <div class="metric-sub" style="margin-top: 5px; opacity: 0.7;">
            Based on local tracking of quota drops.
        </div>
    </div>

    <!-- MODELS GRID -->
    <div class="grid" id="models-grid">
        <!-- Injected via JS -->
    </div>

    <script>
        const vscode = acquireVsCodeApi();

        window.addEventListener('message', event => {
            const message = event.data;
            if (message.type === 'update') {
                updateUI(message.data);
            }
        });

        function getHSL(percentage) {
            // 10% Stepped Logic
            // Snap to floor of 10 (e.g., 96 -> 90, 82 -> 80)
            const stepped = Math.floor(percentage / 10) * 10;
            const hue = (stepped / 100) * 120; // 0 (Red) -> 120 (Green)
            return `hsl(${hue}, 85%, 45%)`;
        }

        function updateUI(data) {
            // Global
            const global = data.global;
            // Replace Global Card Content with Plan Info
            const creditsCard = document.querySelector('.card'); // Reuse first card slot
            const feats = global.features;
            const caps = global.capabilities;

            creditsCard.innerHTML = `
                <div class="card-title">Current Plan</div>
                <div style="display: flex; align-items: center; margin-bottom: 12px;">
                    <div style="font-size: 24px; margin-right: 12px;">ğŸ‘‘</div>
                    <div class="metric-large">${global.planName}</div>
                </div>
                <div class="metric-sub" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                    <div>${feats.fastAutocomplete ? 'âš¡ Fast Autocomplete' : 'âŒ Fast Autocomplete'}</div>
                    <div>${feats.webSearch ? 'ğŸŒ Web Search' : 'âŒ Web Search'}</div>
                    <div>${feats.premiumModels ? 'ğŸ§  Premium Models' : 'âŒ Premium Models'}</div>
                    <div>ğŸ“ ${parseInt(feats.chatInputLimit) / 1024}k Context</div>
                </div>
                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1);">
                    <div class="card-title" style="font-size: 0.8em; margin-bottom: 5px;">Capabilities</div>
                    <div class="metric-sub" style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px; font-size: 0.85em;">
                         <div>${caps.browser ? 'ğŸŸ¢ Browser Tool' : 'âšª Browser Tool'}</div>
                         <div>${caps.knowledgeBase ? 'ğŸŸ¢ Knowledge Base' : 'âšª Knowledge Base'}</div>
                         <div>${caps.mcp ? 'ğŸŸ¢ MCP Servers' : 'âšª MCP Servers'}</div>
                         <div>${caps.autoRun ? 'ğŸŸ¢ Auto-Run' : 'âšª Global Auto-Run'}</div>
                    </div>
                </div>
            `;

            // Weekly Usage
            const weeklyUsage = data.weeklyUsage || 0;
            document.getElementById('weekly-usage').innerText = weeklyUsage.toFixed(2);

            // Models
            const grid = document.getElementById('models-grid');
            grid.innerHTML = ''; // Clear

            // Sort models: Recommended first, then alphabetical
            const models = data.models.sort((a, b) => {
                if (a.isRecommended && !b.isRecommended) return -1;
                if (!a.isRecommended && b.isRecommended) return 1;
                return a.label.localeCompare(b.label);
            });

            models.forEach(m => {
                const q = Math.round(m.rawQuota * 100);
                const colorStyle = `background: ${getHSL(q)}; box-shadow: 0 0 10px ${getHSL(q)}`;

                let resetDisplay = 'N/A';
                let countdownDisplay = '';

                if (m.resetTime) {
                    const now = new Date();
                    const reset = new Date(m.resetTime);
                    resetDisplay = reset.toLocaleString();
                    const diffMs = reset.getTime() - now.getTime();

                    if (diffMs > 0) {
                        const days = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                        const hours = Math.floor((diffMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                        const mins = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));

                        const dStr = days > 0 ? `${days}d ` : '';
                        countdownDisplay = `<div class="metric-sub" style="opacity:0.8; color: var(--accent); margin-top: 2px;">(in ${dStr}${hours}h ${mins}m)</div>`;
                    }
                }

                // Skills Badges (SVGs)
                const createBadge = (type, title) => {
                    let path = '';
                    switch (type) {
                        case 'image': // Eye
                            path = '<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle>';
                            break;
                        case 'docs': // File Text
                            path = '<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline>';
                            break;
                        case 'audio': // Mic
                            path = '<path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line>';
                            break;
                        case 'video': // Video
                            path = '<polygon points="23 7 16 12 23 17 23 7"></polygon><rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect>';
                            break;
                    }
                    return `<div class="skill-icon" title="${title}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            ${path}
                        </svg>
                    </div>`;
                };

                const skillsList = [];
                if (m.skills.image) skillsList.push(createBadge('image', 'Vision: Supports Images'));
                if (m.skills.docs) skillsList.push(createBadge('docs', 'Context: Supports Docs/PDFs'));
                if (m.skills.audio) skillsList.push(createBadge('audio', 'Audio: Supports Voice/Audio'));
                if (m.skills.video) skillsList.push(createBadge('video', 'Video: Supports Video Input'));

                const skillsHtml = skillsList.length ? `<div style="display:flex; gap:6px; margin-top:8px;">${skillsList.join('')}</div>` : '';

                const el = document.createElement('div');
                el.className = 'card';

                el.innerHTML = `
                    <div class="card-title" style="display:flex; align-items:center;">${m.label}${m.tag ? `<span style="background:var(--accent); color:black; font-size:0.7em; padding:2px 6px; border-radius:4px; font-weight:bold; margin-left:8px; vertical-align:middle;">${m.tag.toUpperCase()}</span>` : ''}</div>
                    <div class="metric-large">${q}%</div>
                    <div class="bar-container">
                        <div class="bar-fill" style="width: ${q}%; ${colorStyle}"></div>
                    </div>
                    ${skillsHtml}
                    <div class="metric-sub" style="margin-top: 8px;">Resets: ${resetDisplay}</div>
                    ${countdownDisplay}
                `;
                grid.appendChild(el);
            });
        }
    </script>
</body>

</html>